<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tra c·ª©u quan s√°t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="framework7/framework7-bundle.min.css">
  <link rel="stylesheet" href="css/app.css">
  <style>
    .observation-buttons-horizontal {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .observation-buttons-horizontal .button {
      flex: 1;
      min-width: 60px;
      text-align: center;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="view view-main view-init safe-areas">
      <div class="page" data-name="search">
        <div class="navbar">
          <div class="navbar-inner">
            <div class="title">Tra c·ª©u d·ªØ li·ªáu Observation</div>
          </div>
        </div>

        <div class="page-content">
          <div class="block">
            <form onsubmit="searchPatient(); return false;">
              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">ID b·ªánh nh√¢n</div>
                      <div class="item-input-wrap">
                        <input type="text" id="searchInput" placeholder="Nh·∫≠p ID b·ªánh nh√¢n..." />
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="block">
                <button class="button button-fill" type="submit">T√¨m ki·∫øm</button>
              </div>
            </form>
          </div>

          <div id="resultContainer" class="block"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function searchPatient() {
      const patientId = document.getElementById("searchInput").value.trim();
      if (!patientId) return;

      const container = document.getElementById("resultContainer");
      container.innerHTML = "";

      const types = [
        { key: "temperature", label: "üå°Ô∏è Nhi·ªát ƒë·ªô" },
        { key: "glucose", label: "üß™ Glucose" },
        { key: "blood_pressure", label: "üíâ Huy·∫øt √°p" },
        { key: "heart_rate", label: "‚ù§Ô∏è Nh·ªãp tim" },
        { key: "spo2", label: "ü´Å SpO‚ÇÇ" }
      ];

      const buttons = types.map(t =>
        `<button class="button button-outline" onclick="loadObservation('${patientId}', '${t.key}', '${t.label}')">${t.label}</button>`
      ).join("");

      container.innerHTML = `
        <div class="block-title">Ch·ªçn lo·∫°i quan s√°t</div>
        <div class="observation-buttons-horizontal">${buttons}</div>
        <div id="observationData" class="block" style="margin-top: 1rem;"></div>
      `;
    }

    async function loadObservation(patientId, type, label) {
      try {
        const res = await fetch(`/api/observations/${patientId}`);
        const data = await res.json();
        const filtered = data.filter(o => o.type === type);

        const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = sorted.slice(0, 6).reverse();

        const container = document.getElementById("observationData");
        if (recent.length === 0) {
          container.innerHTML = `<p>Kh√¥ng c√≥ d·ªØ li·ªáu cho ${label}</p>`;
          if (currentChart) currentChart.destroy(); // X√≥a chart n·∫øu c√≥
          return;
        }

        const html = recent.map(o => `<p>${o.date}: ${o.value}</p>`).join("");
        container.innerHTML = `<div class="block-title">${label}</div>${html}`;


        drawChart(type, recent); // ‚úÖ V·∫Ω bi·ªÉu ƒë·ªì ngay sau khi hi·ªÉn th·ªã
      } catch (err) {
        console.error("L·ªói khi l·∫•y d·ªØ li·ªáu:", err);
        document.getElementById("observationData").innerHTML = `<p>L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ server.</p>`;
        if (currentChart) currentChart.destroy();
      }
    }
  </script>

  <canvas id="chart" width="600" height="300"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  let currentChart = null; // Bi·∫øn l∆∞u chart hi·ªán t·∫°i

  function drawChart(type, data) {
  const ctx = document.getElementById("chart").getContext("2d");

  if (currentChart) {
    currentChart.destroy();
  }

  const labels = data.map(item => item.date);
  let datasets;

  if (type === "blood_pressure") {
    const systolic = data.map(item => parseInt(item.value.split("/")[0]));
    const diastolic = data.map(item => parseInt(item.value.split("/")[1]));

    datasets = [
      {
        label: "T√¢m thu",
        data: systolic,
        borderColor: "red",
        fill: false
      },
      {
        label: "T√¢m tr∆∞∆°ng",
        data: diastolic,
        borderColor: "blue",
        fill: false
      }
    ];
  } else {
    datasets = [{
      label: type,
      data: data.map(item => parseFloat(item.value)),
      borderColor: "green",
      fill: false
    }];
  }

  currentChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: `Bi·ªÉu ƒë·ªì ${type}`
        }
      }
    }
  });
}

  // G·ªçi h√†m khi click n√∫t
  //document.getElementById("btn-glucose").addEventListener("click", () => drawChart("glucose", observationData));
  //document.getElementById("btn-spo2").addEventListener("click", () => drawChart("spo2", observationData));
  //document.getElementById("btn-temperature").addEventListener("click", () => drawChart("temperature", observationData));
  //document.getElementById("btn-heart_rate").addEventListener("click", () => drawChart("heart_rate", observationData));
  //document.getElementById("btn-blood_pressure").addEventListener("click", () => drawChart("blood_pressure", observationData));
  </script>

  

  <script src="framework7/framework7-bundle.min.js"></script>
  <script src="js/routes.js"></script>
  <script src="js/store.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
