<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tra c·ª©u quan s√°t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="framework7/framework7-bundle.min.css">
  <link rel="stylesheet" href="css/app.css">
  <style>
    .observation-buttons-horizontal {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .observation-buttons-horizontal .button {
      flex: 1;
      min-width: 60px;
      text-align: center;
      white-space: nowrap;
    }
    #chart {
      margin-top: 1rem;
      max-width: 100%;
    }
    table.data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table.data-table th, table.data-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    table.data-table th {
      background-color: #f5f5f5;
    }
    table.data-table tr:hover {
      background-color: #f0f8ff;
    }
    .patient-link {
      color: #007aff;
      text-decoration: underline;
      cursor: pointer;
    }





    .input-wrapper {
      position: relative;
    }
    .input-wrapper input {
      padding-right: 64px;
    }
    .input-wrapper .clear-button {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: #999;
      background: none;
      border: none;
      cursor: pointer;
    }
    .input-wrapper .search-button {
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      font-size: 16px;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;

      
    }

    .clear-button {
        position: absolute; /* ƒê·ªãnh v·ªã tuy·ªát ƒë·ªëi */
        right: 10px; /* C√°ch l·ªÅ ph·∫£i 10px */
        top: 50%; /* ƒê·∫∑t gi·ªØa theo chi·ªÅu d·ªçc */
        transform: translateY(-50%); /* D·ªãch chuy·ªÉn l√™n tr√™n 50% chi·ªÅu cao c·ªßa n√≥ */
        cursor: pointer; /* Thay ƒë·ªïi con tr·ªè chu·ªôt khi di chuy·ªÉn qua */
        color: #aaa; /* M√†u ch·ªØ */
        font-size: 20px; /* K√≠ch th∆∞·ªõc ch·ªØ */
        font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="view view-main view-init safe-areas">
      <div class="page" data-name="search">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
              <!-- <div class="left">Left</div> -->
              <div class="title" style="color: green;">Tra c·ª©u C·∫≠n L√¢m S√†ng</div>
              <!-- <div class="right">Right</div> -->
          </div>
        </div>
        <div class="page-content">
          <div class="block">
            <form onsubmit="searchPatient(); return false;">
              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">ID ho·∫∑c T√™n</div>
                      <div class="item-input-wrap input-wrapper">
                        <input type="text" id="searchInput" placeholder="Nh·∫≠p ID ho·∫∑c t√™n..." />
                          <span id="clearButton" class="clear-button" onclick="clearSearch()" style="margin-right: 10px;">&times;</span>
                        <button id="searchButton" type="submit" class="search-button">üîç</button>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </form>
          </div>

          <div id="resultContainer" class="block"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function searchPatient() {
      const query = document.getElementById("searchInput").value.trim();
      
      if (!query) {
        alert("Vui l√≤ng nh·∫≠p ID ho·∫∑c t√™n b·ªánh nh√¢n tr∆∞·ªõc khi t√¨m ki·∫øm.");
        return;
      }

      const container = document.getElementById("resultContainer");
      container.innerHTML = "";

      const res = await fetch(`/api/patients/search?query=${encodeURIComponent(query)}`);
      const patients = await res.json();

      if (patients.length === 0) {
        container.innerHTML = `<p>Kh√¥ng t√¨m th·∫•y b·ªánh nh√¢n n√†o kh·ªõp.</p>`;
        return;
      }

      if (patients.length === 1) {
        selectPatient(patients[0].patient_id, patients[0].full_name);
        return;
      }

      const rows = patients.map(p => `
        <tr>
          <td><span class="patient-link" onclick="selectPatient('${p.patient_id}', '${p.full_name}')">${p.full_name}</span></td>
          <td>${p.patient_id}</td>
          <td>${p.gender || ""}</td>
          <td>${p.birth_date || ""}</td>
        </tr>
      `).join("");

      container.innerHTML = `
        <div class="block-title">Ch·ªçn b·ªánh nh√¢n</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>H·ªç t√™n</th>
              <th>ID</th>
              <th>Gi·ªõi t√≠nh</th>
              <th>Ng√†y sinh</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      console.log("patients:", patients);
    }

    function selectPatient(patientId, fullName) {
      const container = document.getElementById("resultContainer");

      const types = [
        { key: "temperature", label: "üå°Ô∏è Nhi·ªát ƒë·ªô" },
        { key: "glucose", label: "üß™ Glucose" },
        { key: "blood_pressure", label: "üíâ Huy·∫øt √°p" },
        { key: "heart_rate", label: "‚ù§Ô∏è Nh·ªãp tim" },
        { key: "spo2", label: "ü´Å SpO‚ÇÇ" }
      ];

      const buttons = types.map(t =>
        `<button class="button button-outline" onclick="loadObservation('${patientId}', '${t.key}', '${t.label}')">${t.label}</button>`
      ).join("");

      container.innerHTML = `
        <div class="block-title" style="font-weight: bold; font-size: 1.2rem; height: 1.25rem;">B·ªánh nh√¢n: ${fullName} (${patientId})</div>
        <div class="block-title" style="font-weight: bold; font-size: 1rem;">Ch·ªçn lo·∫°i c·∫≠n l√¢m s√†ng</div>
        <div class="observation-buttons-horizontal">${buttons}</div>
        <div id="observationData" class="block" style="margin-top: 1rem;"></div>

        <div id="analysisResult" class="block" style="margin-top: 1rem;">
          <div class="block-title" style="font-weight: bold; font-size: 1rem;">üìä Ph√¢n t√≠ch t·ªïng quan</div>
          <table class="data-table" id="analysisTable">
            <thead>
              <tr>
                <th>Ch·ªâ s·ªë</th>
                <th>Xu h∆∞·ªõng</th>
                <th>Trung b√¨nh</th>
                <th>ƒê·ªô l·ªách chu·∫©n</th>
                <th>Rolling Mean</th>
                <th>S·ªë l∆∞·ª£ng</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      `;

      loadAnalysis(patientId);
    }

    async function loadAnalysis(patientId) {
      try {
        const res = await fetch(`/api/observations/${patientId}/analyze`);
        const data = await res.json();
        const tbody = document.querySelector("#analysisTable tbody");
        tbody.innerHTML = "";

        for (const key in data) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${key}</td>
            <td>${data[key].trend}</td>
            <td>${data[key].mean ?? "-"}</td>
            <td>${data[key].std_dev ?? "-"}</td>
            <td>${data[key].latest_rolling_mean ?? "-"}</td>
            <td>${data[key].data_points}</td>
          `;
          tbody.appendChild(row);
        }
      } catch (err) {
        console.error("L·ªói khi ph√¢n t√≠ch:", err);
        document.getElementById("analysisResult").innerHTML = "<p>Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£ ph√¢n t√≠ch.</p>";
      }
    }

    
    async function loadObservation(patientId, type, label) {
      try {
        const res = await fetch(`/api/observations/${patientId}`);
        const data = await res.json();
        const filtered = data.filter(o => o.type === type);

        const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = sorted.slice(0, 6).reverse();

        const container = document.getElementById("observationData");
        if (recent.length === 0) {
          container.innerHTML = `<p>Kh√¥ng c√≥ d·ªØ li·ªáu cho ${label}</p>`;
          if (currentChart) currentChart.destroy();
          return;
        }

        const html = recent.map(o => `<p>${o.date}: ${o.value}</p>`).join("");

        const oldCanvas = document.getElementById("chart");
        if (oldCanvas) oldCanvas.remove();

        container.innerHTML = `
          <div class="block-title">${label}</div>
          ${html}
          <canvas id="chart" width="600" height="300"></canvas>
        `;

        setTimeout(() => drawChart(type, recent), 50);
      } catch (err) {
        console.error("L·ªói khi l·∫•y d·ªØ li·ªáu:", err);
        document.getElementById("observationData").innerHTML = `<p>L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ server.</p>`;
        if (currentChart) currentChart.destroy();
      }
    }
  </script>

  <script>
    async function loadAllPatients() {
      const container = document.getElementById("resultContainer");
      container.innerHTML = "<p>ƒêang t·∫£i danh s√°ch b·ªánh nh√¢n...</p>";

      try {
        const res = await fetch("/api/patients");
        const patients = await res.json();

        if (patients.length === 0) {
          container.innerHTML = "<p>Kh√¥ng c√≥ b·ªánh nh√¢n n√†o trong h·ªá th·ªëng.</p>";
          return;
        }

        const rows = patients.map(p => `
          <tr>
            <td>${p.full_name}</td>
            <td>${p.patient_id}</td>
            <td>${p.gender || ""}</td>
            <td>${p.birth_date || ""}</td>
          </tr>
        `).join("");

        container.innerHTML = `
          <div class="block-title">Danh s√°ch b·ªánh nh√¢n</div>
          <table id="patientTable" class="data-table">
            <thead>
              <tr>
                <th>H·ªç t√™n</th>
                <th>ID</th>
                <th>Gi·ªõi t√≠nh</th>
                <th>Ng√†y sinh</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch (err) {
        container.innerHTML = "<p>L·ªói khi t·∫£i danh s√°ch b·ªánh nh√¢n.</p>";
        console.error(err);
      }

      //ch·ªçn patient khi click v√†oo row tr√™n table patientTable
      selectPatientOnRow() 
    }

    //*** PH·∫¢I C√ì load danh s√°ch b·ªánh nh√¢n v√†o table patientTable tr√™n html
    document.addEventListener("DOMContentLoaded", loadAllPatients);

    //Ch·ªçn patient tr√™n table patientTable
    function selectPatientOnRow() {
      const table = document.querySelector("#patientTable");
      const searchInput = document.querySelector("#searchInput");
      const searchButton = document.querySelector("#searchButton");

      if (table) {
        table.querySelectorAll("tbody tr").forEach((row) => {
          row.addEventListener("click", () => {
            const patientId = row.cells[1]?.textContent?.trim();
            if (patientId) {
              searchInput.value = patientId;
              searchButton.click();
            }
          });
        });
      }
    }





  //const table = document.querySelector("#patientTable");
  //console.log(table);

  //function clearSearch() {
    //document.getElementById("searchInput").value = "";
    //document.getElementById("resultContainer").innerHTML = "";
    //if (currentChart) currentChart.destroy();
    //loadAllPatients(); // g·ªçi l·∫°i danh s√°ch ban ƒë·∫ßu

    //const input = document.getElementById("searchInput");
    //if (input) input.value = ""; // X√≥a n·ªôi dung √¥ nh·∫≠p

    //const container = document.getElementById("resultContainer");
    //container.innerHTML = "";

    //if (currentChart) currentChart.destroy();

    //loadAllPatients(); // Hi·ªán l·∫°i danh s√°ch ban ƒë·∫ßu
  //}

</script>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentChart = null;

    function drawChart(type, data) {
      const ctx = document.getElementById("chart").getContext("2d");
      if (!ctx) return;

      if (currentChart) {
        currentChart.destroy();
      }

      const labels = data.map(item => item.date);
      let datasets;

      if (type === "blood_pressure") {
        const systolic = data.map(item => parseInt(item.value.split("/")[0]));
        const diastolic = data.map(item => parseInt(item.value.split("/")[1]));

        datasets = [
          {
            label: "T√¢m thu",
            data: systolic,
            borderColor: "red",
            fill: false
          },
          {
            label: "T√¢m tr∆∞∆°ng",
            data: diastolic,
            borderColor: "blue",
            fill: false
          }
        ];
      } else {
        datasets = [{
          label: type,
          data: data.map(item => parseFloat(item.value)),
          borderColor: "green",
          fill: false
        }];
      }

      currentChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `Bi·ªÉu ƒë·ªì ${type}`
            }
          }
        }
      });
    }
  </script>

  <script>
    function clearSearch() {
      document.getElementById("searchInput").value = "";
      document.getElementById("resultContainer").innerHTML = "";
      if (currentChart) currentChart.destroy();
      loadAllPatients(); // Hi·ªán l·∫°i danh s√°ch ban ƒë·∫ßu
    }
  </script>

  <script src="framework7/framework7-bundle.min.js"></script>
  <script src="js/routes.js"></script>
  <script src="js/store.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
